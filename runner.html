<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Markdown Table Formatter (Multiline Details Merge)</title>
  </head>
  <body>
    <pre id="output">Loading…</pre>

    <!-- 1) Your formatter bundle -->
    <script src="dist/table-formatter.js"></script>

    <script>
      // —————————————————————————————————————————————
      // 2) Grab & normalize the raw table text
      // —————————————————————————————————————————————

      const params = new URLSearchParams(location.search);
      let raw = decodeURIComponent(params.get("md") || "");

      const FIELD_KEYS = new Set([
        "Reminder Title:",
        "Details:",
        "Link:",
        "List:",
        "Tags:",
        "Due Date:",
        "Alerts:",
        "Location:",
        "Priority:",
        "Flagged:",
        "Completed:",
        "Date Completed:",
        "Parent Task:",
        "Includes Subtasks:",
        "Subtasks:",
        "Images:",
        "File Path:",
        "File Type:",
        "File Size:",
        "Date Created:",
        "Date Modified:",
      ]);

      let lines = raw.split(/\r?\n/);
      const idx = lines.findIndex((l) => /^\|\s*Details:\s*\|/.test(l));
      if (idx !== -1) {
        const mergedDetail = [];
        let i = idx + 1;
        for (; i < lines.length; i++) {
          const m = lines[i].match(/^\|\s*(.*?)\s*\|/);
          const key = m ? m[1].trim() : null;
          if (key && FIELD_KEYS.has(key)) break;
          const m2 = lines[i].match(/^\|\s*.*?\|\s*(.*?)(?:\||$)/);
          if (m2) mergedDetail.push(m2[1].trim());
        }
        if (mergedDetail.length) {
          lines[idx] =
            lines[idx].replace(/\|\s*$/, "") +
            "<br>" +
            mergedDetail.join("<br>") +
            " |";
          lines.splice(idx + 1, mergedDetail.length);
        }
      }
      raw = lines.join("\n");
      console.log("🔄 normalized input:", raw);

      // —————————————————————————————————————————————
      // 3) Format it
      // —————————————————————————————————————————————

      let formatted;
      try {
        formatted = window.formatTable(raw);
        console.log("📤 formatted output:", formatted);
      } catch (err) {
        console.error("❌ formatting error:", err);
        formatted = "Error: " + err.message;
      }

      // —————————————————————————————————————————————
      // 4) Copy to clipboard (if allowed)
      // —————————————————————————————————————————————

      if (navigator.clipboard?.writeText) {
        navigator.clipboard
          .writeText(formatted)
          .then(() => console.log("✅ Copied to clipboard"))
          .catch((e) => console.warn("⚠️ Clipboard write failed", e));
      }

      // —————————————————————————————————————————————
      // 5) Return to Shortcuts or render in browser
      // —————————————————————————————————————————————

      if (typeof completion === "function") {
        completion(formatted);
      } else {
        const out = document.getElementById("output");
        out.style.whiteSpace = "pre";
        out.textContent = formatted;
      }
    </script>
  </body>
</html>
